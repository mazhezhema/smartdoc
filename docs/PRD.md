# SmartDoc 产品需求文档（PRD）

## 1. 产品概述

**产品名称**：SmartDoc（智能文档/电子书转换器）

**定位**：WebApp，支持多种电子书格式互转；用户选择本地文件夹，对其中单个或同类型多个文件进行格式转换，转换完成后**保存为新格式文件并删除原文件**。

**部署**：GitHub 仓库 + Vercel 部署（静态站点 + Serverless API）。

---

## 2. 用户与场景

- **主要用户**：需要将电子书在不同格式间转换的读者（如 PDF→EPUB、EPUB→MOBI、AZW3→EPUB）。
- **典型场景**：批量把某文件夹内的 PDF 转为 EPUB；或把 Kindle 的 AZW3 转为 EPUB 在别的阅读器上看；转换后直接替换原文件，保持目录整洁。

---

## 3. 功能需求

### 3.1 核心流程

1. 用户点击「选择文件夹」，通过浏览器 **File System Access API** 选择本地目录。
2. 系统列举该目录下支持的电子书文件（PDF / EPUB / TXT / MOBI / AZW3），展示**文件列表**（可多选、按类型筛选）。
3. 用户选择**目标格式**（与源格式不同），勾选要转换的文件（可多选同类型）。
4. 用户点击「开始转换」；系统逐文件执行转换，将结果**写入同目录**（新扩展名），并**删除原文件**（仅当新文件写入成功后）。
5. 任务列表实时展示：等待中 / 转换中 / 成功 / 失败；失败时**不删除**原文件。

### 3.2 格式支持矩阵（一期）

| 源 \ 目标 | PDF | EPUB | TXT | MOBI | AZW3 |
|-----------|-----|------|-----|------|------|
| PDF       | -   | ✅   | ✅  | ✅(后端) | ✅(后端) |
| EPUB      | ✅  | -   | ✅  | ✅(后端) | ✅(后端) |
| TXT       | ✅  | ✅  | -   | ✅(后端) | ✅(后端) |
| MOBI      | ✅(前端读) | ✅(前端读) | ✅(前端读) | - | ✅(后端) |
| AZW3      | ✅(前端读) | ✅(前端读) | ✅(前端读) | ✅(后端) | - |

- **前端完成**：PDF/EPUB/TXT 互转；MOBI/AZW3 **读**（解析为中间表示后转 EPUB/TXT/PDF）。
- **后端完成**：任意格式 → MOBI/AZW3；AZW3/MOBI → EPUB（通过 **CloudConvert API**）。

### 3.3 可选：大模型增强

- 用户可开启「大模型增强」并选择模型（如 Gemini Pro、通义千问、DeepSeek 等）。
- 在「提取文本 → 中间表示」环节，将原始文本发给 `/api/llm`，由模型做**文本清洗与结构化**（标题/段落），再生成各格式；不参与 MOBI/AZW3 二进制生成。

### 3.4 非功能需求

- **替换前确认**：执行前可弹窗确认「将转换 N 个文件并删除原文件」。
- **错误处理**：单文件失败不影响其余；失败项在列表中标记，不删原文件。
- **浏览器**：需支持 File System Access API（推荐 Chrome/Edge）；若目标含 MOBI/AZW3，需网络以调用后端。
- **安全**：所有写入 HTML/XML 的文本做转义，防 XSS；API Key 仅存服务端。

---

## 4. 界面与交互（UI）

### 4.1 页面结构

- **顶部**：产品标题「SmartDoc」；当前文件夹名称或「未选择」；可选状态徽章（如「支持 PDF/EPUB/TXT/MOBI/AZW3」）。
- **操作区**：
  - 「选择文件夹」按钮。
  - 目标格式下拉：PDF / EPUB / TXT / MOBI / AZW3（与已选文件源格式不同时可选）。
  - 可选：「大模型增强」开关 + 模型下拉。
  - 「开始转换」按钮（至少选一个文件且目标格式与源不同时可点）。
- **文件列表**：表格或列表，每行：复选框、文件名、格式标签、状态（等待/转换中/成功/失败）；支持「全选当前类型」「按类型筛选」。
- **任务列表/状态**：与文件列表可合并或分块，实时更新每项状态。

### 4.2 交互约束

- 未选文件夹时，文件列表为空，不展示「开始转换」。
- 未选文件或目标格式与源相同：「开始转换」禁用。
- 转换中：「开始转换」与「选择文件夹」禁用，防止重复提交。

---

## 5. 技术边界

- **MOBI/AZW3 写出**：统一通过 **CloudConvert**，Vercel `/api/convert` 代理。
- **大模型**：Vercel `/api/llm`，支持多 provider（Key 存环境变量）。
- **PDF**：仅支持非扫描版（有文本层）；扫描版需 OCR，本期不覆盖。

---

## 6. 需用户提供的 Key / 账号（实现时配置）

- **CloudConvert**：在 [CloudConvert](https://cloudconvert.com) 注册并创建 API Key，用于 `/api/convert`（MOBI/AZW3 等转换）。
- **Vercel**：GitHub 账号关联 Vercel，项目环境变量中配置：
  - `CLOUDCONVERT_API_KEY`
  - （可选）`OPENAI_API_KEY`、`ANTHROPIC_API_KEY`、`GOOGLE_GEMINI_API_KEY`、各国内模型 Key 等，供 `/api/llm`。
- 本地开发：若需调 CloudConvert/LLM，可在本地 `.env` 或 Vercel 开发模式中配置上述 Key，**不要**提交 `.env` 到仓库。

---

## 7. 验收标准（简要）

- 选择文件夹后能正确列出支持的电子书文件。
- 多选文件、选择目标格式后，点击「开始转换」能逐文件转换并写回同目录、删除原文件（成功时）。
- PDF/EPUB/TXT 互转在前端可完成；MOBI/AZW3 写出经 CloudConvert 成功返回。
- 单文件失败时其余继续，失败项不删原文件；界面状态与结果一致。
- 替换前有确认（可选实现）；转换中按钮禁用，防止重复操作。

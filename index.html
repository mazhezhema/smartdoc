<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDoc - æ™ºèƒ½è½¬æ¢</title>
    <!-- ä½¿ç”¨å›½å†…é•œåƒåŠ è½½ CSS -->
    <link href="https://registry.npmmirror.com/tailwindcss/2.2.19/files/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .task-list-height { max-height: 500px; }
        #dropZone { border: 3px dashed #e5e7eb; transition: all 0.3s; }
        #dropZone:hover { border-color: #4f46e5; background-color: #f5f3ff; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto py-10 px-4">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-indigo-700 flex items-center">
                <span class="mr-2">ğŸ”„</span> SmartDoc
            </h1>
            <div class="flex items-center gap-4">
                <span id="engineStatus" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">æ­£åœ¨å‡†å¤‡è½¬æ¢å¼•æ“...</span>
                <select id="targetFormat" class="rounded-md border p-2 text-sm bg-white border-gray-300">
                    <option value="epub">è½¬ä¸º EPUB</option>
                    <option value="txt">è½¬ä¸º TXT</option>
                    <option value="docx">è½¬ä¸º Word (.docx)</option>
                </select>
            </div>
        </div>

        <div id="dropZone" class="rounded-xl p-12 text-center bg-white mb-8 shadow-sm">
            <button id="pickDir" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¼€å§‹</button>
            <p class="text-gray-400 mt-4 text-sm text-center">æˆæƒåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ‰«æå¹¶æ‰§è¡Œâ€œè½¬æ¢ä¸”æ›¿æ¢â€</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 border-b flex justify-between bg-gray-50 items-center">
                <h2 class="text-sm font-bold text-gray-600 uppercase">ä»»åŠ¡é˜Ÿåˆ—</h2>
                <span id="stats" class="text-xs text-gray-400">å°±ç»ª</span>
            </div>
            <div id="taskList" class="p-4 space-y-3 min-h-[200px] task-list-height overflow-y-auto">
                <p class="text-center text-gray-300 py-10">ç­‰å¾…ä»»åŠ¡ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨å›½å†…é•œåƒåŠ è½½å¼•æ“ -->
    <script src="https://registry.npmmirror.com/pandoc-wasm/0.1.7/files/dist/index.js"></script>
    
    <script type="module">
        let pandocEngine = null, isProcessing = false, taskQueue = [], currentDirHandle = null;
        const engineStatus = document.getElementById('engineStatus'), taskListElem = document.getElementById('taskList'), statsElem = document.getElementById('stats');

        async function init() {
            try {
                if (typeof window.Pandoc === 'undefined') {
                    throw new Error("Pandoc è„šæœ¬æœªåŠ è½½ã€‚è¯·å°è¯•ï¼š1. å¼€å¯ Clash å…¨å±€æ¨¡å¼ 2. å…³é—­æµè§ˆå™¨å¹¿å‘Šæ‹¦æˆªæ’ä»¶");
                }

                engineStatus.innerText = "â³ æ­£åœ¨ä»äº‘ç«¯æ‹‰å–è½¬æ¢æ ¸å¿ƒ (çº¦30MB)...";
                // æ ¸å¿ƒå¼•æ“åŠ è½½
                pandocEngine = await window.Pandoc.load();
                
                engineStatus.innerText = "âš¡ å¼•æ“å°±ç»ª";
                engineStatus.className = "text-xs bg-green-100 text-green-700 px-2 py-1 rounded";
            } catch (err) {
                engineStatus.innerText = "âŒ å¤±è´¥: " + err.message;
                engineStatus.className = "text-xs bg-red-100 text-red-700 px-2 py-1 rounded";
                console.error(err);
            }
        }

        // ä¸‹é¢è¿™éƒ¨åˆ†è½¬æ¢é€»è¾‘ä¸ä¹‹å‰ä¸€è‡´...
        async function runConversion(file, targetExt) {
            const buffer = await file.arrayBuffer();
            const fromExt = file.name.split('.').pop().toLowerCase();
            const formatMap = { 'txt': 'markdown', 'mobi': 'mobi', 'epub': 'epub' };
            const result = await pandocEngine.run({
                text: new Uint8Array(buffer),
                from: formatMap[fromExt] || fromExt,
                to: formatMap[targetExt] || targetExt
            });
            return new Blob([result]);
        }

        async function processQueue() {
            if (isProcessing || taskQueue.length === 0) return;
            isProcessing = true;
            while (taskQueue.length > 0) {
                const task = taskQueue[0];
                updateTaskUI(task, 'processing');
                try {
                    const targetFormat = document.getElementById('targetFormat').value;
                    const baseName = task.file.name.substring(0, task.file.name.lastIndexOf('.'));
                    const newName = `${baseName}.${targetFormat}`;
                    const convertedBlob = await runConversion(task.file, targetFormat);
                    const newFileHandle = await currentDirHandle.getFileHandle(newName, { create: true });
                    const writable = await newFileHandle.createWritable();
                    await writable.write(convertedBlob);
                    await writable.close();
                    await currentDirHandle.removeEntry(task.file.name);
                    updateTaskUI(task, 'success', `å·²æ›¿æ¢ä¸º ${newName}`);
                } catch (err) { updateTaskUI(task, 'error', err.message); }
                taskQueue.shift();
                statsElem.innerText = `å‰©ä½™: ${taskQueue.length}`;
            }
            isProcessing = false;
        }

        function updateTaskUI(task, status, msg) {
            const el = document.getElementById(`task-${task.id}`);
            if (!el) return;
            const msgBox = el.querySelector('.msg-box'), statusBox = el.querySelector('.status-box');
            if (status === 'processing') { el.classList.add('bg-indigo-50'); statusBox.innerText = 'è½¬æ¢ä¸­...'; }
            else if (status === 'success') { el.className = "flex items-center justify-between bg-green-50 p-4 rounded-lg border border-green-100 text-xs"; statusBox.innerText = 'âœ… å®Œæˆ'; msgBox.innerText = msg; }
            else if (status === 'error') { el.className = "flex items-center justify-between bg-red-50 p-4 rounded-lg border border-red-100 text-xs"; statusBox.innerText = 'âŒ å¤±è´¥'; msgBox.innerText = msg; }
        }

        function addTaskToUI(task) {
            if (taskListElem.querySelector('p')) taskListElem.innerHTML = '';
            const div = document.createElement('div');
            div.id = `task-${task.id}`;
            div.className = "flex items-center justify-between bg-white p-3 rounded border border-gray-100 shadow-sm text-sm";
            div.innerHTML = `<div class="flex items-center"><span>ğŸ“„</span><div class="ml-3"><p class="font-medium text-gray-800">${task.file.name}</p><p class="text-xs text-gray-400 msg-box">æ’é˜Ÿä¸­...</p></div></div><div class="status-box text-xs font-bold text-indigo-500">ç­‰å¾…</div>`;
            taskListElem.appendChild(div);
        }

        document.getElementById('pickDir').addEventListener('click', async () => {
            if (!pandocEngine) return alert("è¯·ç­‰å¾…å¼•æ“åŠ è½½å®Œæˆ");
            try {
                currentDirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                for await (const entry of currentDirHandle.values()) {
                    if (entry.kind === 'file' && /\.(txt|epub|mobi|pdf|docx)$/i.test(entry.name)) {
                        const file = await entry.getFile();
                        const task = { id: Date.now() + Math.random(), file, handle: entry };
                        addTaskToUI(task);
                        taskQueue.push(task);
                    }
                }
                processQueue();
            } catch (err) { console.warn(err); }
        });
        window.onload = init;
    </script>
</body>
</html>

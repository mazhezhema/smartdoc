<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDoc - æ™ºèƒ½æ–‡æ¡£è½¬æ¢å™¨</title>
    <!-- ä½¿ç”¨é˜¿é‡Œäº‘æä¾›çš„é«˜é€Ÿ Tailwind é•œåƒ -->
    <link href="https://registry.npmmirror.com/tailwindcss/2.2.19/files/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .task-list-height { max-height: 500px; }
        .drop-zone { border: 3px dashed #e5e7eb; transition: all 0.2s ease; }
        .drop-zone:hover { border-color: #4f46e5; background-color: #f9faff; }
        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="max-w-4xl mx-auto py-12 px-4">
        <!-- å¤´éƒ¨ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <h1 class="text-3xl font-extrabold text-indigo-600 flex items-center">
                <span class="mr-3">ğŸ”„</span> SmartDoc
            </h1>
            <div class="flex items-center gap-3">
                <div id="engineStatus" class="text-xs font-bold bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded-full shadow-sm">
                    æ­£åœ¨æ‹‰å–æ ¸å¿ƒç»„ä»¶...
                </div>
                <select id="targetFormat" class="rounded-lg border border-gray-300 p-2 text-sm bg-white shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="epub">ç›®æ ‡: EPUB</option>
                    <option value="txt">ç›®æ ‡: TXT</option>
                    <option value="docx">ç›®æ ‡: Word (.docx)</option>
                    <option value="html">ç›®æ ‡: HTML</option>
                </select>
            </div>
        </div>

        <!-- æ“ä½œåŒº -->
        <div id="dropZone" class="rounded-2xl p-16 text-center bg-white mb-8 shadow-sm">
            <div class="flex justify-center mb-6">
                <button id="pickDir" class="bg-indigo-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 transform transition active:scale-95">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¼€å§‹è½¬æ¢
                </button>
            </div>
            <p class="text-gray-500 mb-4">æˆæƒæ–‡ä»¶å¤¹åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ‰«æå¹¶æ‰§è¡Œâ€œè½¬æ¢ä¸”æ›¿æ¢â€</p>
            <div class="flex items-center justify-center text-sm text-gray-600">
                <input type="checkbox" id="autoReplace" checked class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                <label for="autoReplace" class="ml-2 font-medium cursor-pointer">è½¬æ¢æˆåŠŸåè‡ªåŠ¨åˆ é™¤åŸæ–‡ä»¶ (æ›¿æ¢æ¨¡å¼)</label>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-5 border-b border-gray-100 flex justify-between bg-gray-50 items-center">
                <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest">ä»»åŠ¡é˜Ÿåˆ—æ¸…å•</h2>
                <span id="stats" class="text-xs font-bold text-gray-400">å°±ç»ª</span>
            </div>
            <div id="taskList" class="p-6 space-y-4 min-h-[250px] task-list-height overflow-y-auto text-gray-400">
                <div class="text-center py-12">
                    <p class="text-lg mb-2">ğŸ“­</p>
                    <p>ç­‰å¾…ä»»åŠ¡ä¸­ï¼Œè¯·é€‰æ‹©æ–‡ä»¶å¤¹</p>
                </div>
            </div>
        </div>
        
        <p class="text-center mt-8 text-gray-400 text-xs text-opacity-70">
            Powered by Pandoc-Wasm & File System Access API
        </p>
    </div>

    <!-- å…³é”®ï¼šä»é˜¿é‡Œäº‘ NPM é•œåƒåŠ è½½å¼•æ“ -->
    <script src="https://registry.npmmirror.com/pandoc-wasm/0.1.7/files/dist/index.js"></script>

    <script type="module">
        let pandoc = null;
        let isProcessing = false;
        let taskQueue = [];
        let currentDirHandle = null;

        const engineStatus = document.getElementById('engineStatus');
        const taskListElem = document.getElementById('taskList');
        const statsElem = document.getElementById('stats');

        // 1. åˆå§‹åŒ–å¼•æ“
        async function init() {
            // æ£€æŸ¥è·¨åŸŸéš”ç¦»ç¯å¢ƒï¼ˆVercel éœ€è¦é…ç½® vercel.jsonï¼‰
            if (!window.crossOriginIsolated) {
                console.warn("æç¤º: è·¨åŸŸéš”ç¦»æœªå¼€å¯ï¼Œè½¬æ¢é€Ÿåº¦å¯èƒ½å—é™ã€‚");
            }

            try {
                if (typeof window.Pandoc === 'undefined') {
                    throw new Error("Pandoc è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                }
                
                engineStatus.innerText = "â³ æ­£åœ¨è½½å…¥è½¬æ¢æ¨¡å— (30MB+)...";
                // å¯åŠ¨å¼•æ“
                pandoc = await window.Pandoc.load();
                
                engineStatus.innerText = "âš¡ å¼•æ“å°±ç»ª";
                engineStatus.className = "text-xs font-bold bg-green-100 text-green-700 px-3 py-1.5 rounded-full shadow-sm";
            } catch (err) {
                engineStatus.innerText = "âŒ å¼•æ“åˆå§‹åŒ–å¤±è´¥";
                engineStatus.className = "text-xs font-bold bg-red-100 text-red-700 px-3 py-1.5 rounded-full shadow-sm";
                alert("å¼•æ“åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ Clash è®¾ç½®ã€‚");
            }
        }

        // 2. è½¬æ¢æ ¸å¿ƒé€»è¾‘
        async function convertFile(file, targetExt) {
            const buffer = await file.arrayBuffer();
            const fromExt = file.name.split('.').pop().toLowerCase();
            
            // æ ¼å¼æ˜ å°„
            const formatMap = { 'txt': 'markdown', 'mobi': 'mobi', 'epub': 'epub', 'docx': 'docx' };
            
            const result = await pandoc.run({
                text: new Uint8Array(buffer),
                from: formatMap[fromExt] || fromExt,
                to: formatMap[targetExt] || targetExt
            });
            return new Blob([result]);
        }

        // 3. é˜Ÿåˆ—å¤„ç†å™¨
        async function processQueue() {
            if (isProcessing || taskQueue.length === 0) return;
            isProcessing = true;

            while (taskQueue.length > 0) {
                const task = taskQueue[0];
                updateTaskUI(task, 'processing', 'æ­£åœ¨è½¬æ¢...');

                try {
                    const targetFormat = document.getElementById('targetFormat').value;
                    const baseName = task.file.name.substring(0, task.file.name.lastIndexOf('.'));
                    const newName = `${baseName}.${targetFormat}`;

                    // å¼€å§‹è½¬æ¢
                    const blob = await convertFile(task.file, targetFormat);

                    // å†™å…¥æ–°æ–‡ä»¶
                    const newFileHandle = await currentDirHandle.getFileHandle(newName, { create: true });
                    const writable = await newFileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();

                    // åˆ é™¤åŸæ–‡ä»¶
                    if (document.getElementById('autoReplace').checked) {
                        await currentDirHandle.removeEntry(task.file.name);
                    }
                    updateTaskUI(task, 'success', `æˆåŠŸæ›¿æ¢ä¸º ${newName}`);
                } catch (err) {
                    console.error(err);
                    updateTaskUI(task, 'error', err.message);
                }

                taskQueue.shift();
                statsElem.innerText = `å‰©ä½™ä»»åŠ¡: ${taskQueue.length}`;
            }
            isProcessing = false;
        }

        // 4. UI äº¤äº’å‡½æ•°
        function updateTaskUI(task, status, msg) {
            const el = document.getElementById(`task-${task.id}`);
            if (!el) return;
            const msgBox = el.querySelector('.msg-box');
            const statusBox = el.querySelector('.status-box');
            
            if (status === 'processing') {
                el.className = "flex items-center justify-between bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm";
                statusBox.innerHTML = '<span class="flex items-center text-indigo-600"><svg class="spinning h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>è½¬æ¢ä¸­</span>';
            } else if (status === 'success') {
                el.className = "flex items-center justify-between bg-green-50 p-4 rounded-xl border border-green-100 shadow-sm";
                statusBox.innerHTML = '<span class="text-green-600 font-bold">âœ… å·²å®Œæˆ</span>';
                msgBox.innerText = msg;
                msgBox.classList.add('text-green-700');
            } else if (status === 'error') {
                el.className = "flex items-center justify-between bg-red-50 p-4 rounded-xl border border-red-100 shadow-sm";
                statusBox.innerHTML = '<span class="text-red-600 font-bold">âŒ å¤±è´¥</span>';
                msgBox.innerText = "é”™è¯¯: " + msg;
            }
        }

        function addTaskToUI(task) {
            if (taskListElem.querySelector('.text-center')) taskListElem.innerHTML = '';
            const div = document.createElement('div');
            div.id = `task-${task.id}`;
            div.className = "flex items-center justify-between bg-white p-4 rounded-xl border border-gray-100 shadow-sm transition-all";
            div.innerHTML = `
                <div class="flex items-center">
                    <div class="bg-indigo-100 p-2 rounded-lg mr-4 text-xl">ğŸ“„</div>
                    <div>
                        <p class="text-sm font-bold text-gray-800 truncate max-w-xs md:max-w-md">${task.file.name}</p>
                        <p class="text-xs text-gray-400 msg-box">æ’é˜Ÿç­‰å¾…ä¸­...</p>
                    </div>
                </div>
                <div class="status-box text-xs font-bold text-gray-400">ç­‰å¾…</div>
            `;
            taskListElem.prepend(div);
        }

        // 5. äº‹ä»¶ç»‘å®š
        document.getElementById('pickDir').addEventListener('click', async () => {
            if (!pandoc) return alert("è¯·ç­‰å¾…è½¬æ¢å¼•æ“è½½å…¥å°±ç»ª...");
            try {
                currentDirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                // éå†æ–‡ä»¶
                for await (const entry of currentDirHandle.values()) {
                    if (entry.kind === 'file' && isSupport(entry.name)) {
                        const file = await entry.getFile();
                        const task = { id: Math.random().toString(36).substr(2, 9), file };
                        addTaskToUI(task);
                        taskQueue.push(task);
                    }
                }
                processQueue();
            } catch (err) {
                console.warn("ç”¨æˆ·å…³é—­äº†æƒé™çª—å£");
            }
        });

        function isSupport(name) {
            return /\.(txt|epub|mobi|pdf|docx)$/i.test(name);
        }

        // å¯åŠ¨åˆå§‹åŒ–
        init();
    </script>
</body>
</html>

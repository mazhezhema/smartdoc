<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartDoc - æ™ºèƒ½æ–‡æ¡£è½¬æ¢å™¨</title>

  <!-- UI æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css"
  />

  <style>
    .task-list-height { max-height: 500px; }
    .drop-zone {
      border: 3px dashed #cbd5e1;
      border-radius: 1rem;
      transition: all 0.3s;
    }
    .drop-zone:hover {
      border-color: #4f46e5;
      background-color: #f5f3ff;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto py-12 px-4">
    <div class="flex justify-between items-center mb-10">
      <h1 class="text-3xl font-bold text-indigo-600 flex items-center">
        <span class="mr-2">ğŸ”„</span> SmartDoc
      </h1>
      <div
        id="statusBadge"
        class="text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-600"
      >
        âš¡ PDF å¼•æ“å°±ç»ªï¼ˆéæ‰«æï¼‰
      </div>
    </div>

    <div id="dropZone" class="bg-white p-12 text-center mb-8 shadow-sm">
      <div class="mb-6">
        <select
          id="targetFormat"
          class="mb-4 p-2 border rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <option value="epub">è½¬æ¢ç›®æ ‡: EPUB</option>
          <option value="txt">è½¬æ¢ç›®æ ‡: TXT</option>
        </select>
        <br />
        <button
          id="pickDir"
          class="bg-indigo-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all active:scale-95"
        >
          ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¤„ç†
        </button>
      </div>
      <div class="flex items-center justify-center text-sm text-gray-500">
        <span>å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒã€Œéæ‰«æ PDFã€</span>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div
        class="p-4 bg-gray-50 border-b font-bold text-gray-400 text-xs uppercase tracking-widest text-center"
      >
        ä»»åŠ¡åˆ—è¡¨
      </div>
      <div
        id="taskList"
        class="p-6 task-list-height overflow-y-auto min-h-[250px]"
      >
        <p class="text-center text-gray-300 italic py-10">
          æš‚æ— ä»»åŠ¡ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®
        </p>
      </div>
    </div>
  </div>

  <!-- PDF.jsï¼ˆæ‹† PDF ç”¨ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- JSZipï¼ˆç”Ÿæˆ EPUBï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    let isProcessing = false;
    let queue = [];
    let dirHandle = null;

    const taskList = document.getElementById("taskList");

    /* ========== PDF â†’ TEXT ========== */
    async function pdfToText(file) {
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

      let fullText = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();

        const lines = content.items
          .sort(
            (a, b) =>
              b.transform[5] - a.transform[5] ||
              a.transform[4] - b.transform[4]
          )
          .map(item => item.str);

        fullText += lines.join(" ") + "\n\n";
      }

      return fullText;
    }

    /* ========== TEXT â†’ HTMLï¼ˆè½»é‡é‡å»ºï¼‰ ========== */
    function textToHTML(text) {
      return text
        .split("\n")
        .map(line => {
          const t = line.trim();
          if (!t) return "";
          if (t.length < 30) return `<h2>${t}</h2>`;
          return `<p>${t}</p>`;
        })
        .join("\n");
    }

    /* ========== HTML â†’ EPUB ========== */
    async function htmlToEpub(html, title) {
      const zip = new JSZip();

      zip.file("mimetype", "application/epub+zip");

      zip.folder("META-INF").file(
        "container.xml",
        `<?xml version="1.0"?>
<container version="1.0"
 xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
 <rootfiles>
  <rootfile full-path="OEBPS/content.opf"
   media-type="application/oebps-package+xml"/>
 </rootfiles>
</container>`
      );

      zip.folder("OEBPS").file(
        "content.xhtml",
        `<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>${title}</title></head>
<body>${html}</body>
</html>`
      );

      return await zip.generateAsync({ type: "blob" });
    }

    async function saveFile(name, blob) {
      const handle = await dirHandle.getFileHandle(name, { create: true });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    }

    async function convertAndSave(task) {
      const format = document.getElementById("targetFormat").value;
      const baseName = task.file.name.replace(/\.pdf$/i, "");

      const text = await pdfToText(task.file);

      if (form

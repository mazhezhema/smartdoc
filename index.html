<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDoc - æ™ºèƒ½æ–‡æ¡£æ‰¹é‡è½¬æ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto py-10 px-4">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-indigo-700">ğŸ”„ SmartDoc</h1>
            <div class="flex items-center gap-4">
                <span id="engineStatus" class="text-xs bg-gray-200 px-2 py-1 rounded">å¼•æ“åŠ è½½ä¸­...</span>
                <select id="targetFormat" class="rounded-md border p-2 text-sm bg-white">
                    <option value="epub">è½¬ä¸º EPUB</option>
                    <option value="txt">è½¬ä¸º TXT</option>
                    <option value="docx">è½¬ä¸º Word (.docx)</option>
                </select>
            </div>
        </div>
        <div id="dropZone" class="border-4 border-dashed border-gray-200 rounded-xl p-12 text-center bg-white mb-8">
            <button id="pickDir" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold shadow-md">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¼€å§‹</button>
            <p class="text-gray-400 mt-4 text-sm">æˆæƒåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ‰«æå¹¶æ‰§è¡Œâ€œè½¬æ¢ä¸”æ›¿æ¢â€</p>
            <div class="mt-4 flex items-center justify-center text-sm text-gray-500">
                <input type="checkbox" id="autoReplace" checked class="mr-2">
                <label for="autoReplace">æˆåŠŸåè‡ªåŠ¨åˆ é™¤åŸæ–‡ä»¶ (æ›¿æ¢æ¨¡å¼)</label>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-4 border-b flex justify-between bg-gray-50">
                <h2 class="text-sm font-bold text-gray-600">ä»»åŠ¡é˜Ÿåˆ—</h2>
                <span id="stats" class="text-xs text-gray-400">å°±ç»ª</span>
            </div>
            <div id="taskList" class="p-4 space-y-3 min-h-[200px]">
                <p class="text-center text-gray-300 py-10">ç­‰å¾…ä»»åŠ¡ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/pandoc-wasm@0.1.7/dist/index.js"></script>
    <script type="module">
        let pandocEngine = null, isProcessing = false, taskQueue = [], currentDirHandle = null;
        const engineStatus = document.getElementById('engineStatus'), taskListElem = document.getElementById('taskList'), statsElem = document.getElementById('stats');

        async function init() {
            try {
                pandocEngine = await window.Pandoc.load();
                engineStatus.innerText = "âš¡ å¼•æ“å°±ç»ª";
                engineStatus.className = "text-xs bg-green-100 text-green-700 px-2 py-1 rounded";
            } catch (err) { engineStatus.innerText = "âŒ åŠ è½½å¤±è´¥"; }
        }

        async function processQueue() {
            if (isProcessing || taskQueue.length === 0) return;
            isProcessing = true;
            while (taskQueue.length > 0) {
                const task = taskQueue[0];
                updateTaskUI(task, 'processing', 'å¤„ç†ä¸­...');
                try {
                    const targetFormat = document.getElementById('targetFormat').value;
                    const baseName = task.file.name.substring(0, task.file.name.lastIndexOf('.'));
                    const newName = `${baseName}.${targetFormat}`;
                    
                    const buffer = await task.file.arrayBuffer();
                    const fromExt = task.file.name.split('.').pop().toLowerCase();
                    const formatMap = { 'txt': 'markdown', 'mobi': 'mobi', 'epub': 'epub' };
                    
                    const result = await pandocEngine.run({
                        text: new Uint8Array(buffer),
                        from: formatMap[fromExt] || fromExt,
                        to: formatMap[targetFormat] || targetFormat
                    });

                    const newFileHandle = await currentDirHandle.getFileHandle(newName, { create: true });
                    const writable = await newFileHandle.createWritable();
                    await writable.write(new Blob([result]));
                    await writable.close();

                    if (document.getElementById('autoReplace').checked) {
                        await currentDirHandle.removeEntry(task.file.name);
                    }
                    updateTaskUI(task, 'success', `æˆåŠŸæ›¿æ¢ä¸º ${newName}`);
                } catch (err) { updateTaskUI(task, 'error', err.message); }
                taskQueue.shift();
                statsElem.innerText = `å‰©ä½™: ${taskQueue.length}`;
            }
            isProcessing = false;
        }

        function updateTaskUI(task, status, msg) {
            const el = document.getElementById(`task-${task.id}`);
            if (!el) return;
            const msgBox = el.querySelector('.msg-box'), statusBox = el.querySelector('.status-box');
            if (status === 'processing') { el.classList.add('bg-indigo-50'); statusBox.innerText = 'è½¬æ¢ä¸­...'; }
            else if (status === 'success') { el.className = "flex items-center justify-between bg-green-50 p-4 rounded-lg border border-green-100 text-xs"; statusBox.innerText = 'âœ… å®Œæˆ'; msgBox.innerText = msg; }
            else if (status === 'error') { el.className = "flex items-center justify-between bg-red-50 p-4 rounded-lg border border-red-100 text-xs"; statusBox.innerText = 'âŒ å¤±è´¥'; msgBox.innerText = msg; }
        }

        function addTaskToUI(task) {
            if (taskListElem.querySelector('p')) taskListElem.innerHTML = '';
            const div = document.createElement('div');
            div.id = `task-${task.id}`;
            div.className = "flex items-center justify-between bg-white p-3 rounded border border-gray-100 shadow-sm text-sm";
            div.innerHTML = `<div class="flex items-center"><span>ğŸ“„</span><div class="ml-3"><p class="font-medium text-gray-800">${task.file.name}</p><p class="text-xs text-gray-400 msg-box">æ’é˜Ÿä¸­...</p></div></div><div class="status-box text-xs font-bold text-indigo-500">ç­‰å¾…</div>`;
            taskListElem.appendChild(div);
        }

        document.getElementById('pickDir').addEventListener('click', async () => {
            if (!pandocEngine) return alert("è¯·ç­‰å¾…å¼•æ“åŠ è½½");
            try {
                currentDirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                for await (const entry of currentDirHandle.values()) {
                    if (entry.kind === 'file' && /\.(txt|epub|mobi|pdf|docx)$/i.test(entry.name)) {
                        const file = await entry.getFile();
                        const task = { id: Date.now() + Math.random(), file, handle: entry };
                        addTaskToUI(task);
                        taskQueue.push(task);
                    }
                }
                processQueue();
            } catch (err) { console.warn(err); }
        });
        window.onload = init;
    </script>
</body>
</html>
